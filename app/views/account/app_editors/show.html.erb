<div class="h-screen flex flex-col bg-gray-50 dark:bg-gray-900 overflow-hidden" 
     data-controller="version-preview deployment version-comparison version-actions editor-layout main-tabs preview-device mobile-navigation" 
     data-version-preview-app-id-value="<%= @app.to_param %>"
     data-version-preview-current-version-value="<%= @app.app_versions.order(created_at: :desc).first&.id %>"
     data-deployment-app-id-value="<%= @app.to_param %>"
     data-version-comparison-app-id-value="<%= @app.to_param %>"
     data-editor-layout-chat-visible-value="true"
     data-preview-device-current-device-value="desktop"
     data-mobile-navigation-current-mode-value="preview"
     data-mobile-navigation-chat-panel-outlet="#chat_panel"
     data-mobile-navigation-preview-panel-outlet="#preview_panel"
     data-mobile-navigation-dashboard-panel-outlet="#dashboard_panel"
     data-mobile-navigation-app-id-value="<%= @app.to_param %>">

  <!-- Mobile Header (MOBILE ONLY) -->
  <!-- Shows simplified navigation with logo, app name, and collaborators -->
  <div class="lg:hidden h-14 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 flex items-center justify-between">
    <!-- Left: Overskill Logo (clickable) -->
    <div class="flex items-center">
      <button class="flex items-center space-x-3 p-1 -ml-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
              data-action="click->mobile-navigation#openTeamSettings">
        <!-- Logo -->
        <div class="flex items-center">
          <%= image_tag "overskill-logo.svg", 
              alt: "overskill", 
              class: "h-6 w-auto",
              data: { dark_src: "overskill-logo-dark.svg" } %>
        </div>
      </button>
    </div>
    
    <!-- Center: App Name (clickable) -->
    <div class="flex items-center flex-1 justify-center px-4">
      <button class="text-sm font-medium text-gray-900 dark:text-white truncate p-2 -m-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
              data-action="click->mobile-navigation#openAppSettings">
        <%= @app.name %>
      </button>
    </div>
    
    <!-- Right: Collaborator Avatars + Invite -->
    <div class="flex items-center">
      <!-- Collaborator Avatars -->
      <div class="flex -space-x-2">
        <% if @app.app_collaborators.any? %>
          <% @app.app_collaborators.limit(3).each do |collaborator| %>
            <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 border-2 border-white dark:border-gray-800 flex items-center justify-center">
              <span class="text-xs font-medium text-gray-600 dark:text-gray-300">
                <%= collaborator.user.name.first.upcase %>
              </span>
            </div>
          <% end %>
        <% else %>
          <!-- Default user avatar -->
          <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 border-2 border-white dark:border-gray-800 flex items-center justify-center">
            <span class="text-xs font-medium text-gray-600 dark:text-gray-300">
              <%= current_user.name.first.upcase %>
            </span>
          </div>
        <% end %>
      </div>
      
      <!-- Invite Button -->
      <button class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-colors ml-2"
              data-action="click->mobile-navigation#openInviteModal">
        <i class="fas fa-plus text-xs text-gray-600 dark:text-gray-400"></i>
      </button>
    </div>
  </div>

  <!-- Main Layout Container -->
  <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
  
  <!-- Chat Panel - Left Column on Desktop, Full Screen on Mobile -->
  <div id="chat_panel" 
       class="hidden lg:flex flex-col bg-white dark:bg-gray-900 border-r lg:border-r border-t lg:border-t-0 border-gray-200 dark:border-gray-700 transition-all duration-300 overflow-hidden relative 
              lg:h-auto lg:w-96 w-full order-2 lg:order-1
              [&:not(.lg\\:flex)]:!w-full"
       data-editor-layout-target="chatPanel"
       data-mobile-navigation-target="chatPanel"
       data-controller="resizable-panel"
       data-resizable-panel-min-width-value="320"
       data-resizable-panel-max-width-value="600"
       data-resizable-panel-default-width-value="384"
       style="width: 384px;">
    
    <!-- Chat Panel Header with Team/App Navigation (DESKTOP ONLY) -->
    <!-- Shows team dropdown (Overskill logo) and app dropdown above chat -->
    <div class="hidden lg:flex h-14 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 px-4 items-center">
      <!-- Team Navigation -->
      <%= render "team_navigation" %>
      
      <!-- Divider -->
      <div class="h-5 w-[1px] bg-slate-300 rotate-[25deg] mx-2"></div>
      
      <!-- App Navigation -->
      <%= render "app_navigation", app: @app %>

      <!-- Collapse Button (Desktop Only) -->
      <div class="hidden lg:block absolute top-2 right-2 z-10">
        <button class="p-2 text-gray-600 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                data-action="click->editor-layout#toggleChat">
          <svg class="w-4 h-4 mt-1" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor">

            <g fill="currentColor">

            <path d="M11.726 5.263a.7.7 0 10-.952-1.026l-3.5 3.25a.7.7 0 000 1.026l3.5 3.25a.7.7 0 00.952-1.026L8.78 8l2.947-2.737z"/>

            <path fill-rule="evenodd" d="M1 3.25A2.25 2.25 0 013.25 1h9.5A2.25 2.25 0 0115 3.25v9.5A2.25 2.25 0 0112.75 15h-9.5A2.25 2.25 0 011 12.75v-9.5zm2.25-.75a.75.75 0 00-.75.75v9.5c0 .414.336.75.75.75h1.3v-11h-1.3zm9.5 11h-6.8v-11h6.8a.75.75 0 01.75.75v9.5a.75.75 0 01-.75.75z" clip-rule="evenodd"/>

            </g>

          </svg>
        </button>
      </div>
    </div>
    
    <!-- Chat Content -->
    <div class="flex-1 flex flex-col overflow-hidden relative">
      
      <!-- Chat Messages -->
      <div class="flex-1 overflow-y-auto px-4 py-4 custom-scrollbar" id="chat_container" data-controller="chat-scroller">
        <%= turbo_stream_from "app_#{@app.id}_chat" %>
        <%= turbo_stream_from "app_#{@app.id}" %>
        <div id="chat_messages" class="space-y-4">
          <% if @messages.any? %>
            <% @messages.each do |message| %>
              <%= render message.partial_name, message: message %>
            <% end %>
          <% else %>
            <div class="text-center py-8">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-sparkles text-white text-sm"></i>
              </div>
              <h3 class="text-gray-900 dark:text-gray-100 font-medium text-sm mb-1">Ready to help!</h3>
              <p class="text-gray-500 dark:text-gray-400 text-xs mb-4">I can help you modify, improve, or debug your app.</p>
              
              <div class="space-y-2 text-left max-w-sm mx-auto">
                <button onclick="document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').value = 'Change the color scheme to dark mode'; document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').focus();"
                        class="w-full flex items-center text-xs text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 rounded-lg p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
                  <i class="fas fa-palette text-blue-500 mr-2.5 text-xs"></i>
                  Change the color scheme to dark mode
                </button>
                <button onclick="document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').value = 'Make it mobile responsive'; document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').focus();"
                        class="w-full flex items-center text-xs text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 rounded-lg p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
                  <i class="fas fa-mobile-alt text-green-500 mr-2.5 text-xs"></i>
                  Make it mobile responsive
                </button>
                <button onclick="document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').value = 'Add a navigation menu'; document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').focus();"
                        class="w-full flex items-center text-xs text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 rounded-lg p-2.5 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
                  <i class="fas fa-plus text-purple-500 mr-2.5 text-xs"></i>
                  Add a navigation menu
                </button>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Chat Input (Desktop only, mobile uses bottom navigation) -->
      <div class="hidden lg:block">
        <%= render "chat_input_wrapper", app: @app %>
      </div>
    </div>
    
    <!-- Resize Handle -->
    <div class="absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-blue-500 hover:opacity-30 transition-opacity"
         data-resizable-panel-target="handle"></div>
  </div>
  
  <!-- Main Content Area - Right Column on Desktop, Top on Mobile -->
  <div class="flex-1 flex flex-col min-w-0 order-1 lg:order-2">
    <!-- Desktop Header (DESKTOP ONLY) -->
    <!-- Shows Dashboard/Preview tabs and action buttons -->
    <div class="hidden lg:flex h-14 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 items-center justify-between">
      <!-- Left side - Navigation -->
      <div class="flex items-center">
        <!-- Chat Toggle (when collapsed) -->
        <div class="relative" data-controller="tooltip" data-tooltip-content-value="Show Chat" data-tooltip-position-value="bottom">
          <button class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700 mr-4 <%= 'hidden' unless @editor_layout_chat_visible == false %>"
                  data-action="click->editor-layout#toggleChat mouseenter->tooltip#show mouseleave->tooltip#hide"
                  data-editor-layout-target="expandButton">
              <svg class="w-4 h-4" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                <path fill-rule="evenodd" d="M3.25 1A2.25 2.25 0 001 3.25v9.5A2.25 2.25 0 003.25 15h9.5A2.25 2.25 0 0015 12.75v-9.5A2.25 2.25 0 0012.75 1h-9.5zM2.5 3.25a.75.75 0 01.75-.75h1.8v11h-1.8a.75.75 0 01-.75-.75v-9.5zM6.45 13.5h6.3a.75.75 0 00.75-.75v-9.5a.75.75 0 00-.75-.75h-6.3v11z" clip-rule="evenodd"/>
              </svg>
          </button>
        </div>
        
        <!-- Main Navigation Tabs -->
        <div class="flex items-center">
          <button class="px-3 py-1 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white border-b-2 border-transparent"
                  data-main-tabs-target="tab"
                  data-panel="dashboard"
                  data-action="click->main-tabs#switchTab">
            Dashboard
          </button>
          <button class="px-3 py-1 text-sm font-medium text-gray-900 dark:text-white border-b-2 border-primary-500 ml-4"
                  data-main-tabs-target="tab"
                  data-panel="preview"
                  data-action="click->main-tabs#switchTab">
            Preview
          </button>
        </div>
      </div>
      
      <!-- Right side - Actions -->
      <div class="flex items-center space-x-3">
        <!-- Desktop Actions (DESKTOP ONLY) -->
        <div class="hidden lg:flex items-center space-x-3">
          <!-- Preview Controls (shown when preview tab is active) -->
          <div class="flex items-center space-x-2 mr-4" data-main-tabs-target="previewControls">
            <% # Show page selector for React apps with preview URL to navigate between routes %>
            <% react_pages = @app.app_files.where("path LIKE 'src/pages/%.tsx'").pluck(:path).map { |p| p.gsub('src/pages/', '').gsub('.tsx', '') } %>
            <% has_react_pages = react_pages.any? && @app.preview_url.present? %>
            <% if has_react_pages %>
            <!-- Page Selector (Desktop) - For React Router navigation -->
            <div class="relative"
                 data-controller="page-selector"
                 data-page-selector-app-id-value="<%= @app.id %>"
                 data-page-selector-current-page-value="/"
                 data-page-selector-preview-url-value="<%= @app.preview_url %>">
              <button class="flex items-center space-x-2 px-3 py-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded transition-colors"
                      data-action="click->page-selector#toggleDropdown">
                <i class="fas fa-route text-sm text-gray-500 dark:text-gray-400"></i>
                <span class="text-sm text-gray-700 dark:text-gray-300" data-page-selector-target="currentPageName">Home (/)</span>
                <i class="fas fa-chevron-down text-xs text-gray-500 dark:text-gray-400"></i>
              </button>
              
              <!-- Page Dropdown -->
              <div class="absolute z-50 mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hidden min-w-[200px]"
                   data-page-selector-target="dropdown">
                <div class="py-1 max-h-64 overflow-y-auto">
                  <!-- Home route -->
                  <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center"
                          data-action="click->page-selector#selectPage"
                          data-page-selector-page-param="/"
                          data-page-selector-display-param="Home (/)">
                    <i class="fas fa-home text-xs text-gray-400 mr-2"></i>
                    <span class="text-gray-700 dark:text-gray-300">Home (/)</span>
                  </button>
                  
                  <% # Add other React pages %>
                  <% react_pages.each do |page_name| %>
                    <% next if page_name == 'Index' # Skip Index as it's the home route %>
                    <% next if page_name == 'NotFound' # Skip NotFound as it's a catch-all %>
                    <% route_path = "/#{page_name.downcase}" %>
                    <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center"
                            data-action="click->page-selector#selectPage"
                            data-page-selector-page-param="<%= route_path %>"
                            data-page-selector-display-param="<%= page_name %> (<%= route_path %>)">
                      <i class="fas fa-file-code text-xs text-gray-400 mr-2"></i>
                      <span class="text-gray-700 dark:text-gray-300"><%= page_name %> (<%= route_path %>)</span>
                    </button>
                  <% end %>
                </div>
              </div>
            </div>
            <% end %>
            
            <!-- Device Toggle -->
            <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded p-1">
              <div class="relative" data-controller="tooltip" data-tooltip-content-value="Switch to desktop view" data-tooltip-position-value="bottom">
                <button class="px-2 py-1 text-sm rounded transition-colors"
                        data-action="click->preview-device#setDesktop mouseenter->tooltip#show mouseleave->tooltip#hide"
                        data-preview-device-target="desktopButton">
                  <i class="fas fa-desktop"></i>
                </button>
              </div>
              <div class="relative" data-controller="tooltip" data-tooltip-content-value="Switch to mobile view" data-tooltip-position-value="bottom">
                <button class="px-2 py-1 text-sm text-gray-500 dark:text-gray-400 rounded transition-colors"
                        data-action="click->preview-device#setMobile mouseenter->tooltip#show mouseleave->tooltip#hide"
                        data-preview-device-target="mobileButton">
                  <i class="fas fa-mobile-alt"></i>
                </button>
              </div>
            </div>
            
            <!-- Divider -->
            <div class="h-6 w-px bg-gray-300 dark:bg-gray-600 ml-2"></div>
          </div>
          
          <!-- Activity Monitor -->
          <div class="relative" data-controller="tooltip" data-tooltip-content-value="View activity logs and API usage" data-tooltip-position-value="bottom">
            <button class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                    data-action="click->editor-layout#toggleActivityMonitor mouseenter->tooltip#show mouseleave->tooltip#hide">
              <i class="fas fa-chart-line text-sm"></i>
            </button>
          </div>
          
          <!-- Version History -->
          <div class="relative" data-controller="tooltip" data-tooltip-content-value="Browse previous versions of your app" data-tooltip-position-value="bottom">
            <button class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                    data-action="click->editor-layout#openVersionHistory mouseenter->tooltip#show mouseleave->tooltip#hide">
              <i class="fas fa-history text-sm"></i>
            </button>
          </div>
          
          <!-- Help -->
          <div class="relative" data-controller="tooltip" data-tooltip-content-value="Get help and documentation" data-tooltip-position-value="bottom">
            <button class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                    data-action="click->editor-layout#openHelpModal mouseenter->tooltip#show mouseleave->tooltip#hide">
              <i class="fas fa-question-circle text-sm"></i>
            </button>
          </div>
          
          <!-- Collaborators -->
          <div class="flex items-center mr-2">
            <!-- Collaborator Avatars -->
            <div class="flex -space-x-2 mr-2">
              <% if @app.app_collaborators.any? %>
                <% @app.app_collaborators.limit(3).each do |collaborator| %>
                  <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 border-2 border-white dark:border-gray-800 flex items-center justify-center"
                       data-controller="tooltip" 
                       data-tooltip-content-value="<%= collaborator.user.name %>" 
                       data-tooltip-position-value="bottom">
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-300">
                      <%= collaborator.user.name.first.upcase %>
                    </span>
                  </div>
                <% end %>
                <% if @app.app_collaborators.count > 3 %>
                  <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 border-2 border-white dark:border-gray-800 flex items-center justify-center"
                       data-controller="tooltip" 
                       data-tooltip-content-value="<%= @app.app_collaborators.count - 3 %> more collaborators" 
                       data-tooltip-position-value="bottom">
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400">
                      +<%= @app.app_collaborators.count - 3 %>
                    </span>
                  </div>
                <% end %>
              <% else %>
                <!-- Default user avatar if no collaborators -->
                <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 border-2 border-white dark:border-gray-800 flex items-center justify-center"
                     data-controller="tooltip" 
                     data-tooltip-content-value="<%= current_user.name %>" 
                     data-tooltip-position-value="bottom">
                  <span class="text-xs font-medium text-gray-600 dark:text-gray-300">
                    <%= current_user.name.first.upcase %>
                  </span>
                </div>
              <% end %>
            </div>
            
            <!-- Invite Button -->
            <button class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-colors"
                    data-action="click->editor-layout#openInviteModal"
                    data-controller="tooltip" 
                    data-tooltip-content-value="Invite collaborators" 
                    data-tooltip-position-value="bottom">
              <i class="fas fa-plus text-xs text-gray-600 dark:text-gray-400"></i>
            </button>
          </div>
          
          <!-- Share -->
          <div class="relative" data-controller="tooltip" data-tooltip-content-value="Share your app with others" data-tooltip-position-value="bottom">
            <button class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200 dark:hover:bg-gray-600"
                    data-action="click->editor-layout#openShareModal mouseenter->tooltip#show mouseleave->tooltip#hide">
              Share
            </button>
          </div>
          
          <!-- Publish -->
          <div class="relative" data-controller="tooltip" data-tooltip-content-value="Deploy your app to production" data-tooltip-position-value="bottom">
            <button data-action="click->editor-layout#openPublishModal mouseenter->tooltip#show mouseleave->tooltip#hide"
                    class="px-4 py-1.5 text-sm font-medium bg-primary-600 text-white rounded hover:bg-primary-700">
              Publish
            </button>
          </div>
        </div>
        
        <!-- Mobile Actions (MOBILE ONLY) -->
        <!-- Shows overflow menu and publish button only -->
        <div class="lg:hidden flex items-center space-x-2">
          <!-- Overflow Menu -->
          <div class="relative" data-controller="dropdown">
            <button class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                    data-action="click->dropdown#toggle">
              <i class="fas fa-ellipsis-v text-sm"></i>
            </button>
            
            <div class="absolute right-0 top-full mt-1 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 hidden"
                 data-dropdown-target="menu">
              <div class="py-1">
                <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"
                        data-action="click->editor-layout#toggleActivityMonitor">
                  <i class="fas fa-chart-line text-sm mr-2"></i>
                  Activity Monitor
                </button>
                <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"
                        data-action="click->editor-layout#openVersionHistory">
                  <i class="fas fa-history text-sm mr-2"></i>
                  Version History
                </button>
                <button class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"
                        data-action="click->editor-layout#openShareModal">
                  <i class="fas fa-share text-sm mr-2"></i>
                  Share App
                </button>
              </div>
            </div>
          </div>
          
          <!-- Mobile Publish Button -->
          <button data-action="click->mobile-navigation#openPublishModal"
                  class="px-3 py-1.5 text-sm font-medium bg-primary-600 text-white rounded hover:bg-primary-700">
            Publish
          </button>
        </div>
      </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="flex-1 bg-white dark:bg-gray-900 overflow-hidden">
      <!-- Dashboard View -->
      <div id="dashboard_panel" class="h-full hidden overflow-hidden" data-main-tabs-target="panel" data-mobile-navigation-target="dashboardPanel" data-panel-name="dashboard">
        <%= render "dashboard_with_subnav", app: @app, files: @files, selected_file: @selected_file %>
      </div>
      
      <!-- Preview View -->
      <div id="preview_panel" class="h-full relative" data-main-tabs-target="panel" data-mobile-navigation-target="previewPanel" data-panel-name="preview">
        <%= render "preview_frame", app: @app %>
      </div>
    </div>
  </div>
  
  
  <!-- Activity Monitor Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" data-editor-layout-target="activityModal">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-3xl max-h-[80vh] flex flex-col">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Activity Monitor</h2>
          <button class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  data-action="click->editor-layout#closeActivityMonitor">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6">
          <%= render "activity_monitor", app: @app %>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mobile Bottom Navigation Bar -->
  <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 rounded-t-2xl z-40">
    
    <!-- Mobile Preview Controls (shown when in preview mode) -->
    <div id="mobile_preview_controls"
         class="hidden border-b border-gray-200 dark:border-gray-700"
         data-mobile-navigation-target="previewControls"
         <% if has_react_pages %>
         data-controller="page-selector"
         data-page-selector-app-id-value="<%= @app.id %>"
         data-page-selector-current-page-value="/"
         data-page-selector-preview-url-value="<%= @app.preview_url %>"
         <% end %>>
      <div class="flex items-center justify-between px-3 py-2">
        <% if has_react_pages %>
        <!-- Page Selector -->
        <div class="flex-1 mr-2 relative">
          <button class="w-full flex items-center justify-between bg-gray-100 dark:bg-gray-700 rounded px-2.5 py-1.5 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                  data-action="click->page-selector#toggleDropdown">
            <div class="flex items-center min-w-0">
              <i class="fas fa-route text-[11px] text-gray-500 dark:text-gray-400 mr-1.5"></i>
              <span class="text-xs text-gray-700 dark:text-gray-300 truncate" data-page-selector-target="currentPageName">Home (/)</span>
            </div>
            <i class="fas fa-chevron-down text-[10px] text-gray-500 dark:text-gray-400 ml-1"></i>
          </button>
          
          <!-- Page Dropdown Menu -->
          <div class="absolute z-50 mt-1 w-full bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 hidden"
               data-page-selector-target="dropdown">
            <div class="py-1 max-h-64 overflow-y-auto">
              <!-- Home route -->
              <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center"
                      data-action="click->page-selector#selectPage"
                      data-page-selector-page-param="/"
                      data-page-selector-display-param="Home (/)">
                <i class="fas fa-home text-xs text-gray-400 mr-2"></i>
                <span class="text-gray-700 dark:text-gray-300">Home (/)</span>
              </button>
              
              <% # Add other React pages %>
              <% react_pages.each do |page_name| %>
                <% next if page_name == 'Index' # Skip Index as it's the home route %>
                <% next if page_name == 'NotFound' # Skip NotFound as it's a catch-all %>
                <% route_path = "/#{page_name.downcase}" %>
                <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center"
                        data-action="click->page-selector#selectPage"
                        data-page-selector-page-param="<%= route_path %>"
                        data-page-selector-display-param="<%= page_name %> (<%= route_path %>)">
                  <i class="fas fa-file-code text-xs text-gray-400 mr-2"></i>
                  <span class="text-gray-700 dark:text-gray-300"><%= page_name %> (<%= route_path %>)</span>
                </button>
              <% end %>
            </div>
          </div>
        </div>
        <% end %>
        
        <!-- Control Actions -->
        <div class="flex items-center space-x-1">
          <!-- Refresh -->
          <button class="p-1.5 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                  data-action="click->mobile-navigation#refreshPreview">
            <i class="fas fa-sync-alt text-[11px]"></i>
          </button>
          
          <!-- Open in New Tab -->
          <button class="p-1.5 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                  data-action="click->mobile-navigation#openInNewTab">
            <i class="fas fa-external-link-alt text-[11px]"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Mobile Chat Input (shown when in chat mode) -->
    <div id="mobile_chat_input"
         class="hidden border-b border-gray-200 dark:border-gray-700"
         data-mobile-navigation-target="chatInput">
      <%= render "account/app_editors/chat_form", app: @app %>
    </div>
    
    <!-- Main Navigation -->
    <div class="flex items-center justify-between h-16 px-4">
      <!-- Left Action Button (contextual) -->
      <button class="p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              data-mobile-navigation-target="leftAction"
              data-action="click->mobile-navigation#handleLeftAction">
        <!-- Plus icon in chat mode, history in preview mode, menu in dashboard -->
        <i class="fas fa-plus text-gray-600 dark:text-gray-400 hidden" data-mobile-navigation-target="plusIcon"></i>
        <i class="fas fa-history text-gray-600 dark:text-gray-400" data-mobile-navigation-target="historyIcon"></i>
        <i class="fas fa-bars text-gray-600 dark:text-gray-400 hidden" data-mobile-navigation-target="menuIcon"></i>
      </button>
      
      <!-- Center: 3-Way Mode Toggle -->
      <div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-full p-0.5">
        <button class="px-3 py-1.5 text-sm font-medium rounded-full transition-all text-gray-600 dark:text-gray-400"
                data-mobile-navigation-target="chatTab"
                data-action="click->mobile-navigation#showChat">
          Chat
        </button>
        <button class="px-3 py-1.5 text-sm font-medium rounded-full transition-all bg-white dark:bg-gray-800 shadow-sm"
                data-mobile-navigation-target="previewTab"
                data-action="click->mobile-navigation#showPreview">
          Preview
        </button>
        <button class="px-3 py-1.5 text-sm font-medium rounded-full transition-all text-gray-600 dark:text-gray-400"
                data-mobile-navigation-target="dashboardTab"
                data-action="click->mobile-navigation#showDashboard">
          <i class="fas fa-cog text-sm"></i>
        </button>
      </div>
      
      <!-- Right Action Button (contextual) -->
      <button class="p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              data-mobile-navigation-target="rightAction"
              data-action="click->mobile-navigation#handleRightAction">
        <!-- Different icons based on mode -->
        <i class="fas fa-info-circle text-gray-600 dark:text-gray-400 hidden" data-mobile-navigation-target="infoIcon"></i>
        <i class="fas fa-rocket text-gray-600 dark:text-gray-400" data-mobile-navigation-target="publishIcon"></i>
        <i class="fas fa-save text-gray-600 dark:text-gray-400 hidden" data-mobile-navigation-target="saveIcon"></i>
      </button>
    </div>
  </div>
  
</div>

<!-- Publish Modal -->
<%= render "publish_modal", app: @app %>

<!-- Share Modal -->
<%= render "share_modal", app: @app %>

<!-- Invite Modal -->
<%= render "invite_modal", app: @app %>

<!-- Help Modal -->
<%= render "help_modal" %>

<!-- Version Comparison Modal -->
<%= render "version_comparison_modal", app: @app %>

<!-- Version History Modal -->
<%= render "version_history_modal", app: @app %>

<!-- App Settings Modal -->
<%= render "app_settings_modal", app: @app %>
</div>