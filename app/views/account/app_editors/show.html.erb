<div class="h-screen flex flex-col bg-gray-900" 
     data-controller="version-preview deployment" 
     data-version-preview-app-id-value="<%= @app.id %>"
     data-version-preview-current-version-value="<%= @app.app_versions.order(created_at: :desc).first&.id %>"
     data-deployment-app-id-value="<%= @app.id %>">
  <!-- Header -->
  <div class="bg-gray-800 border-b border-gray-700 px-4 py-2 flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <!-- Team Navigation Dropdown -->
      <%= render "team_navigation" %>
      
      <%= link_to account_team_apps_path(@app.team), class: "text-gray-400 hover:text-white" do %>
        <i class="fas fa-arrow-left"></i>
      <% end %>
      
      <!-- App Navigation Dropdown -->
      <%= render "app_navigation", app: @app %>
    </div>
    
    <div class="flex items-center space-x-4">
      <% if @app.preview_url.present? %>
        <%= link_to @app.preview_url, target: "_blank", 
            class: "text-sm text-gray-400 hover:text-white",
            data: { deployment_preview: true } do %>
          <i class="fas fa-external-link-alt mr-1"></i> Open Preview
        <% end %>
      <% end %>
      <button data-action="click->publish-modal#open"
              class="text-sm bg-primary-600 text-white px-3 py-1 rounded hover:bg-primary-700">
        <i class="fas fa-globe mr-1"></i> Publish
      </button>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Left Panel - Chat -->
    <div class="w-96 bg-gray-50 border-r border-gray-200 flex flex-col">
      <!-- Chat Header -->
      <div class="px-6 py-4 border-b border-gray-200 bg-white">
        <h2 class="text-gray-900 font-semibold text-lg">AI Assistant</h2>
        <p class="text-sm text-gray-600 mt-1">Describe changes to make to your app</p>
      </div>
      
      <!-- Chat Messages -->
      <div class="flex-1 overflow-y-auto px-6 py-4" id="chat_container" data-controller="chat-scroller">
        <%= turbo_stream_from "app_#{@app.id}_chat" %>
        <div id="chat_messages" class="space-y-4">
          <% if @messages.any? %>
            <% @messages.each do |message| %>
              <%= render "chat_message", message: message %>
            <% end %>
          <% else %>
            <div class="text-center py-12">
              <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-sparkles text-white"></i>
              </div>
              <h3 class="text-gray-900 font-medium mb-2">Ready to help!</h3>
              <p class="text-gray-600 text-sm mb-6">I can help you modify, improve, or debug your app.</p>
              
              <div class="space-y-3 text-left max-w-sm mx-auto">
                <div class="flex items-center text-sm text-gray-700 bg-white rounded-lg p-3 border border-gray-200">
                  <i class="fas fa-palette text-blue-500 mr-3"></i>
                  "Change the color scheme to dark mode"
                </div>
                <div class="flex items-center text-sm text-gray-700 bg-white rounded-lg p-3 border border-gray-200">
                  <i class="fas fa-mobile-alt text-green-500 mr-3"></i>
                  "Make it mobile responsive"
                </div>
                <div class="flex items-center text-sm text-gray-700 bg-white rounded-lg p-3 border border-gray-200">
                  <i class="fas fa-plus text-purple-500 mr-3"></i>
                  "Add a navigation menu"
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- Chat Input -->
      <div class="p-6 border-t border-gray-200 bg-white" id="chat_form">
        <%= render "chat_form", app: @app %>
      </div>
    </div>
    
    <!-- Right Panel - Preview/Code -->
    <div class="flex-1 bg-gray-900 flex flex-col"
         data-controller="tabs"
         data-tabs-debug="true">
      <!-- Tabs -->
      <div class="bg-gray-800 border-b border-gray-700 px-4 flex items-center space-x-1"
           id="tabs-container">
        <button class="px-4 py-2 text-sm font-medium text-white border-b-2 border-primary-500"
                data-tabs-target="tab"
                data-panel="preview"
                data-action="click->tabs#switchTab">
          <i class="fas fa-eye mr-2"></i>Preview
        </button>
        <button class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent"
                data-tabs-target="tab"
                data-panel="files"
                data-action="click->tabs#switchTab">
          <i class="fas fa-folder mr-2"></i>Files (<%= @files.count %>)
        </button>
      </div>
      
      <!-- Tab Panels -->
      <div class="flex-1 overflow-hidden relative">
        <!-- Preview Panel -->
        <div class="h-full absolute inset-0" data-tabs-target="panel" data-panel-name="preview">
          <%= render "preview_frame", app: @app %>
        </div>
        
        <!-- Files Panel -->
        <div class="h-full hidden absolute inset-0" data-tabs-target="panel" data-panel-name="files">
          <!-- Debug: Files count = <%= @files.count %> -->
          <% if @files.any? %>
            <div class="h-full flex">
              <!-- File Tree -->
              <%= render "file_tree", files: @files, selected_file: @selected_file, app: @app %>
              
              <!-- Code Display -->
              <div class="flex-1 bg-gray-900" id="code_editor">
                <% if @selected_file %>
                  <%= render "code_editor", file: @selected_file, app: @app %>
                <% else %>
                  <div class="h-full flex items-center justify-center text-gray-500">
                    <div class="text-center">
                      <i class="fas fa-code text-4xl mb-4"></i>
                      <p>Select a file to view its contents</p>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="h-full flex items-center justify-center text-gray-500">
              <div class="text-center">
                <i class="fas fa-folder-open text-6xl mb-4"></i>
                <p class="text-xl">No files found for this app</p>
                <p class="text-sm mt-2">Generate files using the AI Assistant</p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Publish Modal -->
<%= render "publish_modal", app: @app %>