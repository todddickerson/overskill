<div id="preview_frame" class="h-full flex flex-col min-h-0" 
     data-controller="version-preview"
     data-version-preview-app-id-value="<%= app.id %>">
  
  <div class="h-full bg-gray-50 dark:bg-gray-900 flex flex-col min-h-0">
    
    <!-- Version header (hidden by default) -->
    <div data-version-preview-target="versionHeader" 
         class="hidden bg-blue-50 dark:bg-blue-900/20 border-b border-blue-200 dark:border-blue-800 px-6 py-2 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <i class="fas fa-code-branch text-blue-600 dark:text-blue-400"></i>
        <span class="text-sm text-gray-700 dark:text-gray-300">Previewing version</span>
        <span data-version-preview-target="currentVersionBadge" 
              class="px-2 py-0.5 bg-blue-600 text-white text-xs rounded font-medium">
          v1.0.0
        </span>
      </div>
      
      <div class="flex items-center space-x-2">
        <button data-version-preview-target="restoreButton"
                data-action="click->version-preview#restoreVersion"
                class="hidden px-3 py-1 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded flex items-center">
          <i class="fas fa-history mr-2"></i>
          Restore This Version
        </button>
        
        <button data-action="click->version-preview#showLatest"
                class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
          <i class="fas fa-times mr-1"></i>
          Back to Latest
        </button>
      </div>
    </div>
    
    <!-- Preview Content Area -->  
    <div class="flex-1 relative p-4 box-border min-h-0">
      <div class="h-full bg-white dark:bg-gray-900 rounded-xl shadow-xl overflow-hidden"
           data-preview-device-target="container">
        <% if app.preview_url.present? %>
          <% # For deployed apps with Cloudflare URL, use the preview URL with optional path %>
          <% preview_src = app.preview_url %>
          <% # Check if there's a selected page path to append (for React Router navigation) %>
          <% if defined?(selected_page_path) && selected_page_path.present? && selected_page_path != '/' %>
            <% preview_src = "#{app.preview_url.chomp('/')}#{selected_page_path}" %>
          <% end %>
          <iframe 
            data-version-preview-target="iframe"
            data-preview-device-target="iframe"
            data-controller="error-detector"
            data-error-detector-app-id-value="<%= app.id %>"
            data-preview-base-url-value="<%= app.preview_url %>"
            src="<%= preview_src %>"
            class="w-full h-full border-0"
            sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox"
            title="App Preview">
          </iframe>
        <% else %>
          <div class="h-full flex items-center justify-center text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800">
            <div class="text-center">
              <%= image_tag "overskill-loader.svg", class: "w-20 h-20 mb-12 mx-auto opacity-60" %>

              <!-- Auto-scrolling feature list (bottom-to-top) with fades -->
              <div class="relative mt-4 max-w-sm mx-auto h-40 overflow-hidden">
                <!-- top/bottom fade overlays -->
                <div class="pointer-events-none absolute inset-x-0 top-0 h-8 bg-gradient-to-b from-gray-50 dark:from-gray-800 to-transparent z-10"></div>
                <div class="pointer-events-none absolute inset-x-0 bottom-0 h-8 bg-gradient-to-t from-gray-50 dark:from-gray-800 to-transparent z-10"></div>

                <ul class="vertical-marquee text-sm space-y-6 mx-auto w-max z-0">
                  <li class="flex items-center gap-2"><i class="fas fa-magic"></i><span>AI‑first app generation in minutes</span></li>
                  <li class="flex items-center gap-2"><i class="fas fa-database"></i><span>Built‑in database & User logins</span></li>
                  <li class="flex items-center gap-2"><i class="fas fa-dollar-sign"></i><span>Stripe Connect payments & payouts day one</span></li>
                  <li class="flex items-center gap-2"><i class="fas fa-cloud-upload-alt"></i><span>One‑click global deploys on Cloudflare</span></li>
                  <li class="flex items-center gap-2"><i class="fas fa-store"></i><span>Marketplace & subscriptions baked in</span></li>
                  <li class="flex items-center gap-2"><i class="far fa-eye"></i><span>Instant live preview while you edit</span></li>
                  <li class="flex items-center gap-2"><i class="fas fa-shield-alt"></i><span>Security scanning & best practices</span></li>
                  <li class="flex items-center gap-2"><i class="fab fa-github"></i><span>Export clean code to GitHub anytime</span></li>
                  <li class="flex items-center gap-2"><i class="fas fa-chart-line"></i><span>Built‑in analytics, logs, and insights</span></li>
                  <!-- duplicate items for seamless loop -->
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fas fa-magic"></i><span>AI‑first app generation in minutes</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fas fa-database"></i><span>Built‑in database & auth (Supabase)</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fas fa-dollar-sign"></i><span>Stripe Connect payments & payouts day one</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fas fa-cloud-upload-alt"></i><span>One‑click global deploys on Cloudflare</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fas fa-store"></i><span>Marketplace & subscriptions baked in</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="far fa-eye"></i><span>Instant live preview while you edit</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fas fa-shield-alt"></i><span>Security scanning & RLS best practices</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fab fa-github"></i><span>Export clean code to GitHub anytime</span></li>
                  <li aria-hidden="true" class="flex items-center gap-2"><i class="fas fa-chart-line"></i><span>Built‑in analytics, logs, and insights</span></li>
                </ul>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<style>
/* Simple bottom-to-top marquee for the features list.
   Kept inline to scope to this preview-only view. */
@keyframes vertical-marquee {
  0% { transform: translateY(0); }
  100% { transform: translateY(-50%); }
}

.vertical-marquee {
  display: inline-block;
  will-change: transform;
  animation: vertical-marquee 14s linear infinite;
}

@media (prefers-reduced-motion: reduce) {
  .vertical-marquee { animation: none; }
}
</style>