<div id="app_chat_message_<%= message.id %>" class="mb-6 message-content" data-message-status="<%= message.status if message.role == 'assistant' %>">
  <% if message.role == 'user' %>
    <!-- User message - simple gray bubble, no icon -->
    <div class="flex justify-end">
      <div class="max-w-[70%] bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-2xl px-4 py-3">      
        <div class="text-sm leading-relaxed break-words" 
             data-controller="expandable-text"
             data-expandable-text-collapsed-height-value="120">
          <div data-expandable-text-target="content" class="relative">
            <%= simple_format(message.content, {}, sanitize: false) %>
          </div>
          <button data-expandable-text-target="toggle" 
                  data-action="click->expandable-text#toggle"
                  class="hidden text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 mt-2 underline transition-colors duration-200">
            <span data-expandable-text-target="showMore">Show more</span>
            <span data-expandable-text-target="showLess" class="hidden">Show less</span>
          </button>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Assistant message - icon + plain text (no bubble) -->
    <div class="flex items-start space-x-3">
      <div class="w-7 h-7 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
        <i class="fas fa-sparkles text-white text-xs"></i>
      </div>
      
      <div class="flex-1 max-w-[80%]">
        <div class="text-sm leading-relaxed break-words text-gray-900 dark:text-gray-100" 
             data-controller="expandable-text"
             data-expandable-text-collapsed-height-value="120">
          <div data-expandable-text-target="content" class="relative">
            <%= simple_format(message.content, {}, sanitize: false) %>
          </div>
          <button data-expandable-text-target="toggle" 
                  data-action="click->expandable-text#toggle"
                  class="hidden text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 mt-2 underline transition-colors duration-200">
            <span data-expandable-text-target="showMore">Show more</span>
            <span data-expandable-text-target="showLess" class="hidden">Show less</span>
          </button>
        </div>
        
        <% if message.status.present? %>
          <div class="mt-2 flex items-center text-xs text-gray-500 dark:text-gray-400 transition-colors duration-200">
            <div class="w-1.5 h-1.5 rounded-full mr-2 <%= message.status == 'completed' ? 'bg-green-500' : message.status == 'failed' ? 'bg-red-500' : 'bg-yellow-500 animate-pulse' %>"></div>
            <%= message.status_text %>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Check for What's next section and quick actions -->
    <% if message.role == 'assistant' && message.content.include?("What's next?") %>
      <% 
        # Parse quick actions from the message
        suggestions = []
        bugs = []
        
        # Extract bugs
        if message.content.match(/⚠️ \*\*Potential issues detected:\*\*\n(.*?)\n\n/m)
          bugs_text = $1
          bugs_text.split("\n").each do |line|
            if line.start_with?("- ")
              bugs << { message: line.sub("- ", "") }
            end
          end
        end
        
        # Extract quick actions
        if message.content.match(/\*\*Quick actions:\*\*\n(.*?)$/m)
          actions_text = $1
          actions_text.split("\n").each do |line|
            if match = line.match(/\[(.*?)\]:\s*(.*)/)
              suggestions << { label: match[1], prompt: match[2] }
            end
          end
        end
      %>
      
      <% if suggestions.any? || bugs.any? %>
        <div class="ml-10 mt-4">
          <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-3">Quick actions</h4>
            
            <% if bugs.any? %>
              <div class="mb-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-md">
                <p class="text-xs font-medium text-yellow-800 dark:text-yellow-200 mb-2">⚠️ Potential issues:</p>
                <ul class="text-xs text-yellow-700 dark:text-yellow-300 space-y-1">
                  <% bugs.each do |bug| %>
                    <li>• <%= bug[:message] %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>
            
            <div class="flex flex-wrap gap-2">
              <% suggestions.each do |suggestion| %>
                <button onclick="document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').value = '<%= suggestion[:prompt].gsub("'", "\\'") %>'; document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').focus();"
                        class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                  <%= suggestion[:label] %>
                </button>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
  
  <% if message.role == 'assistant' && message.status == 'completed' %>
    <% version = message.app_version || message.app.app_versions.order(created_at: :desc).first %>
    <% if version %>
      <div class="ml-10 mt-4 relative group">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
          <!-- Version header -->
          <div class="px-4 py-3 bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <span class="text-sm font-medium text-gray-900 dark:text-gray-100">Version <%= version.version_number %></span>
                <span class="text-xs text-gray-500 dark:text-gray-400">
                  <%= time_ago_in_words(version.created_at) %> ago
                </span>
                <% if version.bookmarked? %>
                  <i class="fas fa-bookmark text-yellow-500 text-xs" title="Bookmarked"></i>
                <% end %>
              </div>
            </div>
          </div>
          
          <!-- Changelog content -->
          <% if version.changelog.present? %>
            <div class="px-4 py-3">
              <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                <%= version.changelog %>
              </p>
            </div>
          <% end %>
        </div>
        
        <!-- Hover pill buttons -->
        <div class="absolute -bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10">
          <div class="flex items-center space-x-2 bg-white dark:bg-gray-800 rounded-full shadow-lg border border-gray-200 dark:border-gray-700 px-2 py-1">
            <button onclick="window.postMessage({action: 'preview', version: '<%= version.id %>'}, '*')"
                    class="text-xs text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-2 py-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                    title="Preview this version">
              <i class="fas fa-eye mr-1"></i>Preview
            </button>
            <div class="w-px h-4 bg-gray-300 dark:bg-gray-600"></div>
            <button onclick="window.postMessage({action: 'compare', version: '<%= version.id %>'}, '*')"
                    class="text-xs text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-2 py-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                    title="Compare with current">
              <i class="fas fa-code-branch mr-1"></i>Compare
            </button>
            <div class="w-px h-4 bg-gray-300 dark:bg-gray-600"></div>
            <button data-action="click->version-actions#bookmark"
                    data-version-actions-version-id-value="<%= version.id %>"
                    class="text-xs <%= version.bookmarked? ? 'text-yellow-500' : 'text-gray-600 dark:text-gray-300' %> hover:text-yellow-500 px-2 py-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                    title="<%= version.bookmarked? ? 'Remove bookmark' : 'Bookmark this version' %>">
              <i class="fas fa-bookmark"></i>
            </button>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>