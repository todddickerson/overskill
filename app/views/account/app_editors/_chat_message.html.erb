<div id="app_chat_message_<%= message.id %>" class="mb-4 message-content" data-message-status="<%= message.status if message.role == 'assistant' %>">
  <% if message.role == 'user' %>
    <!-- User message - simple, right-aligned -->
    <div class="flex justify-end">
      <div class="max-w-[80%] bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 rounded-lg px-3 py-2">      
        <div class="text-sm leading-relaxed break-words" 
             data-controller="expandable-text"
             data-expandable-text-collapsed-height-value="120">
          <div data-expandable-text-target="content" class="relative">
            <%= render_markdown(message.content) %>
          </div>
          <button data-expandable-text-target="toggle" 
                  data-action="click->expandable-text#toggle"
                  class="hidden text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 mt-2 underline transition-colors duration-200">
            <span data-expandable-text-target="showMore">Show more</span>
            <span data-expandable-text-target="showLess" class="hidden">Show less</span>
          </button>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Assistant message - small icon + text -->
    <div class="flex items-start space-x-2">
      <%= image_tag "overskill-logo.svg", 
          alt: "OverSkill AI", 
          class: "w-6 h-6 flex-shrink-0 mt-0.5" %>
      
      <div class="flex-1">
        <div class="text-sm leading-relaxed break-words text-gray-700 dark:text-gray-300" 
             data-controller="expandable-text"
             data-expandable-text-collapsed-height-value="120">
          <div data-expandable-text-target="content" class="relative">
            <%= render_markdown(message.content) %>
          </div>
          <button data-expandable-text-target="toggle" 
                  data-action="click->expandable-text#toggle"
                  class="hidden text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 mt-2 underline transition-colors duration-200">
            <span data-expandable-text-target="showMore">Show more</span>
            <span data-expandable-text-target="showLess" class="hidden">Show less</span>
          </button>
        </div>
        
        <% if message.status.present? %>
          <div class="mt-1 flex items-center text-xs text-gray-500 dark:text-gray-400">
            <div class="w-1 h-1 rounded-full mr-1.5 <%= message.status == 'completed' ? 'bg-green-500' : message.status == 'failed' ? 'bg-red-500' : 'bg-yellow-500 animate-pulse' %>"></div>
            <%= message.status_text %>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- Unified Version Card (handles both progress and completed states) -->
    <%= render "account/app_editors/unified_version_card", message: message, next_version_number: next_app_version_number(message.app) %>
    
    <!-- Check for What's next section and quick actions -->
    <% if message.role == 'assistant' && message.content.include?("What's next?") %>
      <% 
        # Parse quick actions from the message using helper methods
        suggestions = extract_suggestions_from_markdown(message.content)
        bugs = extract_bugs_from_markdown(message.content)
      %>
      
      <% if suggestions.any? || bugs.any? %>
        <div class="ml-8 mt-3">
          <% if bugs.any? %>
            <div class="mb-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded text-xs">
              <p class="font-medium text-yellow-800 dark:text-yellow-200 mb-1">‚ö†Ô∏è Potential issues:</p>
              <ul class="text-yellow-700 dark:text-yellow-300 space-y-0.5">
                <% bugs.each do |bug| %>
                  <li>‚Ä¢ <%= bug[:message] %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <div class="flex flex-wrap gap-1.5">
            <% suggestions.each do |suggestion| %>
              <button onclick="document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').value = '<%= suggestion[:prompt].gsub("'", "\\'").gsub('"', '&quot;') %>'; document.querySelector('textarea[name=&quot;app_chat_message[content]&quot;]').focus();"
                      class="inline-flex items-center px-2.5 py-1 text-xs text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <% if suggestion[:icon] %>
                  <% case suggestion[:icon] %>
                  <% when 'üîß' %>
                    <i class="fas fa-wrench mr-1 text-xs"></i>
                  <% when '‚ú®' %>
                    <i class="fas fa-sparkles mr-1 text-xs"></i>
                  <% when 'üé®' %>
                    <i class="fas fa-palette mr-1 text-xs"></i>
                  <% when 'üì±' %>
                    <i class="fas fa-mobile-alt mr-1 text-xs"></i>
                  <% when '‚ö°' %>
                    <i class="fas fa-bolt mr-1 text-xs"></i>
                  <% when 'üéØ' %>
                    <i class="fas fa-bullseye mr-1 text-xs"></i>
                  <% when 'üìä' %>
                    <i class="fas fa-chart-bar mr-1 text-xs"></i>
                  <% when 'üîî' %>
                    <i class="fas fa-bell mr-1 text-xs"></i>
                  <% when 'üíæ' %>
                    <i class="fas fa-save mr-1 text-xs"></i>
                  <% end %>
                <% end %>
                <%= suggestion[:label] %>
              </button>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>