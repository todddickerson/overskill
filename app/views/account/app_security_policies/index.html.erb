<%# Transparent Security Policies - Superior to Base44's Hidden Security %>
<div class="container mx-auto max-w-7xl px-4 py-8">
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
          Security Policies
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
          Complete transparency into how your data is protected. Unlike competitors, we show you exactly how security works.
        </p>
      </div>
      <div class="flex space-x-3">
        <%= link_to account_app_audit_logs_path(@app), 
            class: "btn btn-secondary" do %>
          <i class="fas fa-history mr-2"></i>
          View Audit Logs
        <% end %>
        <%= link_to account_app_security_policies_path(@app, format: :pdf),
            target: "_blank",
            class: "btn btn-primary" do %>
          <i class="fas fa-download mr-2"></i>
          Download Report
        <% end %>
      </div>
    </div>
  </div>

  <%# Security Overview %>
  <div class="grid md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Data Isolation
        </h3>
        <div class="w-12 h-12 bg-green-100 dark:bg-green-900/50 rounded-full flex items-center justify-center">
          <i class="fas fa-shield-alt text-green-600 dark:text-green-400"></i>
        </div>
      </div>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
        <%= @security_report[:data_isolation][:level] %> Level
      </p>
      <p class="text-xs text-gray-500 dark:text-gray-500">
        Enforced at <%= @security_report[:data_isolation][:enforcement] %>
      </p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Active Policies
        </h3>
        <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/50 rounded-full flex items-center justify-center">
          <i class="fas fa-lock text-blue-600 dark:text-blue-400"></i>
        </div>
      </div>
      <p class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
        <%= @policies.count %>
      </p>
      <p class="text-xs text-gray-500 dark:text-gray-500">
        All policies active and enforced
      </p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Audit Trail
        </h3>
        <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/50 rounded-full flex items-center justify-center">
          <i class="fas fa-clipboard-check text-purple-600 dark:text-purple-400"></i>
        </div>
      </div>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
        <%= @audit_config[:retention_days] %> days retention
      </p>
      <p class="text-xs text-gray-500 dark:text-gray-500">
        Tracking <%= @audit_config[:tracked_operations].join(', ') %>
      </p>
    </div>
  </div>

  <%# Row-Level Security Policies %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
        Row-Level Security (RLS) Policies
      </h2>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        These policies ensure data isolation between organizations at the database level.
      </p>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-200 dark:border-gray-700">
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Table
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Policy
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Operation
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Description
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Status
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Details
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          <% @policies.each do |policy| %>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                <%= policy[:table] %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-xs">
                  <%= policy[:name] %>
                </code>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                  <%= operation_badge_color(policy[:operation]) %>">
                  <%= policy[:operation] %>
                </span>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                <%= policy[:description] %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <% if policy[:enabled] %>
                  <span class="inline-flex items-center text-green-600 dark:text-green-400">
                    <i class="fas fa-check-circle mr-1"></i>
                    Active
                  </span>
                <% else %>
                  <span class="inline-flex items-center text-gray-400">
                    <i class="fas fa-pause-circle mr-1"></i>
                    Inactive
                  </span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <%= link_to "View SQL", 
                    account_app_security_policy_path(@app, policy[:name]),
                    class: "text-primary-600 hover:text-primary-700 text-sm" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <%# Security Functions %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-8">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
        Security Helper Functions
      </h2>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        Database functions that enforce security policies.
      </p>
    </div>
    
    <div class="p-6 space-y-4">
      <% @security_functions.each do |function| %>
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="font-mono text-sm font-medium text-gray-900 dark:text-white">
                <%= function[:name] %>(<%= function[:parameters].join(', ') %>)
              </h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                <%= function[:description] %>
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                Returns: <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded"><%= function[:returns] %></code>
              </p>
            </div>
            <button onclick="toggleFunctionSQL('<%= function[:name] %>')" 
                    class="text-sm text-primary-600 hover:text-primary-700">
              <i class="fas fa-code"></i>
              View SQL
            </button>
          </div>
          <div id="function_<%= function[:name] %>_sql" class="hidden mt-4">
            <pre class="bg-gray-100 dark:bg-gray-900 p-4 rounded overflow-x-auto text-xs"><%= function[:sql] %></pre>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# Compliance Status %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
        Compliance Features
      </h2>
    </div>
    
    <div class="p-6">
      <div class="grid md:grid-cols-2 gap-6">
        <% @security_report[:compliance_features].each do |feature, enabled| %>
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
              <%= feature.to_s.humanize %>
            </span>
            <% if enabled %>
              <span class="flex items-center text-green-600 dark:text-green-400">
                <i class="fas fa-check-circle mr-2"></i>
                Enabled
              </span>
            <% else %>
              <span class="flex items-center text-gray-400">
                <i class="fas fa-times-circle mr-2"></i>
                Disabled
              </span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
function toggleFunctionSQL(functionName) {
  const element = document.getElementById(`function_${functionName}_sql`);
  element.classList.toggle('hidden');
}

<% def operation_badge_color(operation)
  case operation
  when 'SELECT'
    'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300'
  when 'INSERT'
    'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300'
  when 'UPDATE'
    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'
  when 'DELETE'
    'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'
  else
    'bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300'
  end
end %>
</script>