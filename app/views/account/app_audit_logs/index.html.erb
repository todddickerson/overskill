<%# Transparent Audit Logs - Complete visibility unlike Base44 %>
<div class="container mx-auto max-w-7xl px-4 py-8">
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
          Audit Logs
        </h1>
        <p class="text-gray-600 dark:text-gray-400">
          Complete audit trail for compliance and security. Every change is tracked and visible.
        </p>
      </div>
      <div class="flex space-x-3">
        <%= link_to compliance_report_account_app_audit_logs_path(@app),
            class: "btn btn-secondary" do %>
          <i class="fas fa-clipboard-check mr-2"></i>
          Compliance Report
        <% end %>
        <%= link_to export_account_app_audit_logs_path(@app, format: :json),
            class: "btn btn-primary" do %>
          <i class="fas fa-download mr-2"></i>
          Export Logs
        <% end %>
      </div>
    </div>
  </div>

  <%# Activity Summary %>
  <div class="grid md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-gray-900 dark:text-white">
            <%= @summary[:total_changes] %>
          </p>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Changes (24h)
          </p>
        </div>
        <i class="fas fa-edit text-gray-400"></i>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-green-600 dark:text-green-400">
            <%= @summary[:by_operation]['INSERT'] || 0 %>
          </p>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Records Created
          </p>
        </div>
        <i class="fas fa-plus-circle text-green-400"></i>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">
            <%= @summary[:by_operation]['UPDATE'] || 0 %>
          </p>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Records Updated
          </p>
        </div>
        <i class="fas fa-sync text-yellow-400"></i>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-red-600 dark:text-red-400">
            <%= @summary[:by_operation]['DELETE'] || 0 %>
          </p>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Records Deleted
          </p>
        </div>
        <i class="fas fa-trash text-red-400"></i>
      </div>
    </div>
  </div>

  <%# Search and Filters %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
    <div class="p-4">
      <%= form_with url: search_account_app_audit_logs_path(@app), 
                    method: :get,
                    data: { controller: "audit-search", turbo_frame: "audit_logs" },
                    class: "flex gap-4" do |f| %>
        <div class="flex-1">
          <%= f.text_field :q, 
              placeholder: "Search by user, table, or record ID...",
              class: "w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white",
              data: { audit_search_target: "input" } %>
        </div>
        
        <select name="operation" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
          <option value="">All Operations</option>
          <option value="INSERT">Insert</option>
          <option value="UPDATE">Update</option>
          <option value="DELETE">Delete</option>
        </select>
        
        <select name="table" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
          <option value="">All Tables</option>
          <% @app.app_tables.each do |table| %>
            <option value="<%= table.name %>"><%= table.name %></option>
          <% end %>
        </select>
        
        <%= f.submit "Search", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

  <%# Audit Log Entries %>
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow" id="audit_logs">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-200 dark:border-gray-700">
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Timestamp
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              User
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Table
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Operation
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Record
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Changes
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
              Details
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
          <% @logs.each do |log| %>
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                <%= Time.parse(log['created_at']).strftime('%Y-%m-%d %H:%M:%S') %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center mr-2">
                    <i class="fas fa-user text-xs"></i>
                  </div>
                  <%= truncate(log['user_id'], length: 8) %>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                <%= log['table_name'] %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                  <%= operation_badge_color(log['operation']) %>">
                  <%= log['operation'] %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-xs">
                  <%= truncate(log['record_id'], length: 8) %>
                </code>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                <% case log['operation'] %>
                <% when 'INSERT' %>
                  New record created
                <% when 'UPDATE' %>
                  <%= log['data']['changed_fields']&.keys&.join(', ') || 'Fields updated' %>
                <% when 'DELETE' %>
                  Record deleted
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <button onclick="showAuditDetails('<%= log['id'] %>')" 
                        class="text-primary-600 hover:text-primary-700 text-sm">
                  <i class="fas fa-eye"></i>
                  View
                </button>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    
    <% if @logs.empty? %>
      <div class="p-8 text-center text-gray-500 dark:text-gray-400">
        <i class="fas fa-history text-4xl mb-4"></i>
        <p>No audit logs found</p>
      </div>
    <% end %>
  </div>

  <%# Pagination %>
  <div class="mt-6 flex justify-between items-center">
    <div class="text-sm text-gray-600 dark:text-gray-400">
      Showing <%= [@logs.count, 50].min %> of <%= @summary[:total_changes] %> total entries
    </div>
    <div class="flex space-x-2">
      <% if params[:offset].to_i > 0 %>
        <%= link_to "Previous", 
            account_app_audit_logs_path(@app, offset: [params[:offset].to_i - 50, 0].max),
            class: "btn btn-secondary btn-sm" %>
      <% end %>
      <% if @logs.count == 50 %>
        <%= link_to "Next", 
            account_app_audit_logs_path(@app, offset: params[:offset].to_i + 50),
            class: "btn btn-secondary btn-sm" %>
      <% end %>
    </div>
  </div>
</div>

<%# Audit Details Modal %>
<div id="audit-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Audit Log Details
      </h3>
    </div>
    <div class="p-6 overflow-y-auto flex-1" id="audit-details-content">
      <!-- Content loaded dynamically -->
    </div>
    <div class="p-6 border-t border-gray-200 dark:border-gray-700">
      <button onclick="closeAuditDetails()" class="btn btn-secondary">
        Close
      </button>
    </div>
  </div>
</div>

<script>
function showAuditDetails(logId) {
  // In production, this would fetch details via AJAX
  document.getElementById('audit-details-modal').classList.remove('hidden');
}

function closeAuditDetails() {
  document.getElementById('audit-details-modal').classList.add('hidden');
}

// Close modal on escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAuditDetails();
  }
});

<% def operation_badge_color(operation)
  case operation
  when 'INSERT'
    'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300'
  when 'UPDATE'
    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'
  when 'DELETE'
    'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'
  else
    'bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300'
  end
end %>
</script>